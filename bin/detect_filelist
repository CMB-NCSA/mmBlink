#!/usr/bin/env python
import spt3g_detect.dtools as du
import argparse
import time


def cmdline():
    """
    Parses command-line arguments for the SPT-3G transient detection script.

    Returns:
        argparse.Namespace: Parsed command-line arguments.
    """
    parser = argparse.ArgumentParser(description="spt3g transient detection")
    parser.add_argument("files", nargs='+',
                        help="Filename(s) to ingest")
    parser.add_argument("--outdir", type=str, action='store', default=None,
                        required=True, help="Location for output files")
    parser.add_argument("--clobber", action='store_true', default=False,
                        help="Clobber output files")

    parser.add_argument("--field", type=str, action='store', default=None,
                        help="Field name (i.e. SourceName) for automatically determining point source file to use.")
    parser.add_argument("--bands",  nargs='+', action='store', default=['90GHz', '150GHz'],
                        help="List of bands to use [90GHz, 150GHz, 200GHz]")
    parser.add_argument("--multi_detection", action='store_true', default=False,
                        help="Detection must be in both bands [90GHz, 150GHz]")
    parser.add_argument("--single_detection", action='store_true', default=False,
                        help="Detection per band alone")
    parser.add_argument("--stamp_size", type=float, action='store', default=10,
                        help="Size (in arcmin) of the stamps to be cut (default:10)")
    parser.add_argument("--prefix", type=str, action='store', default="SPT3G",
                        help="Prefix for IAU ID for objects (default: SPT3G)")
    # Logging options (loglevel/log_format/log_format_date)
    default_log_format = '[%(asctime)s.%(msecs)03d][%(levelname)s][%(name)s][%(funcName)s] %(message)s'
    default_log_format_date = '%Y-%m-%d %H:%M:%S'
    parser.add_argument("--loglevel", action="store", default='INFO', type=str.upper,
                        choices=["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"],
                        help="Logging Level [DEBUG/INFO/WARNING/ERROR/CRITICAL]")
    parser.add_argument("--log_format", action="store", type=str, default=default_log_format,
                        help="Format for logging")
    parser.add_argument("--log_format_date", action="store", type=str, default=default_log_format_date,
                        help="Format for date section of logging")
    # Detection options
    parser.add_argument("--rms2D", action='store_true', default=False,
                        help="Perform 2D map of the rms using photutils Background2D StdBackgroundRMS")
    parser.add_argument("--rms2D_box", action='store', type=int, default=60,
                        help="Size of box using photutils Background2D StdBackgroundRMS")
    parser.add_argument("--rms2D_image", action='store_true', default=False,
                        help="Create a FITS image of the Background2D")
    parser.add_argument("--npixels", action='store', type=int, default=20,
                        help="Compress output files with astropy.io.fits.CompImageHDU")
    parser.add_argument("--nsigma_thresh", action='store', type=float, default=5.0,
                        help="Number of sigmas use to compute the detection threshold")
    parser.add_argument("--max_sep", action='store', type=float, default=20.0,
                        help="Maximum angular separation to match sources in arcsec")
    parser.add_argument("--ell_cut", action='store', type=float, default=0.3,
                        help="Ellipticity cut")
    parser.add_argument("--plot", action='store_true', default=False,
                        help="Plot detection diagnostics?")
    parser.add_argument("--nr", action="store", default=1, type=int,
                        help="N-repeat, number of times source repeats [default=1]")
    # Use multiprocessing
    parser.add_argument("--np", action="store", default=1, type=int,
                        help="Run using multi-process, 0=automatic, 1=single-process [default]")
    parser.add_argument("--ntheads", action="store", default=1, type=int,
                        help="The number of threads used by numexpr 0=automatic, 1=single [default]")

    args = parser.parse_args()
    if args.multi_detection == args.single_detection:
        raise ValueError("Must set --multi_detection or --single_detection")

    args.bands.sort()
    return args


if __name__ == "__main__":
    """
    Main execution script for running transient detection on SPT-3G data.

    - Parses command-line arguments.
    - Runs the detection pipeline.
    - Matches detected sources across bands.
    - Generates output files including detection catalogs and cutouts.
    """
    # Start timing the script execution
    t0 = time.time()

    # Parse command-line arguments
    args = cmdline()

    # Initialize detection worker with parsed arguments
    d3w = du.detect_3gworker(**args.__dict__)

    # Run the detection on input files
    d3w.run_detection_files()
    d3w.logger.info(f"Total time: {du.elapsed_time(t0)} for [run_detection_files]")

    # Source matching
    if args.multi_detection:
        stacked_centroids = d3w.match_dual_bands()
        print("---------------------------- Done dual band -------------------------")
        d3w.logger.info("Running unique centroids for [stacked_centroids]")
        stacked_centroids = du.find_unique_centroids(stacked_centroids, separation=args.max_sep, plot=args.plot)
    else:
        # Extract unique detections
        stacked_centroids = du.find_unique_centroids(d3w.cat, separation=args.max_sep, plot=args.plot)

    # Write the catalog of centroids
    d3w.write_centroids(stacked_centroids)

    # Generate cutouts and repack results
    d3w.run_cutouts(stacked_centroids)
    d3w.repack_lc()
    d3w.repack_stamps()
    print(f"Grand total time: {du.elapsed_time(t0)}")

    exit()

    # Example 1, find all positions
    stacked_centroids = du.find_unique_centroids(d3w.cat, separation=args.max_sep, plot=args.plot)
    # print("stacked_centroids:")
    # print(stacked_centroids)
    print(f"Total time: {du.elapsed_time(t0)}")
    exit()

    # Example 2: Find repeating sources across observations
    table_centroids = du.find_repeating_sources(d3w.cat, separation=args.max_sep, plot=args.plot, outdir=args.outdir)
    stacked_centroids = du.find_unique_centroids(table_centroids, separation=args.max_sep, plot=args.plot)
    print("stacked_centroids:")
    print(stacked_centroids)
    print(f"Total time: {du.elapsed_time(t0)}")
